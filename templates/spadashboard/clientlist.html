{% extends 'spadashboard/index.html' %}
{% load static %}
{% block heading %}

<div class="page-title-wrapper">

    <div class="page-title-heading">
        <div class="page-title-icon">
            <i class="fa fa-user icon-gradient bg-mean-fruit">
            </i>
        </div>
        <div>
            Manage Client
            <div class="page-title-subheading">You can manage your clients here.
            </div>
        </div>
    </div>
    <div class="page-title-actions">
        <button id="btnaddclient" type="button" class="btn btn-info">
            <span class="btn-icon-wrapper">
                <i class="fa fa-user-plus fa-fw"></i>
            </span>
            Add Client
        </button>
    </div>
</div>

{% endblock %}
{% block home %}

<!--add client-->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    $(document).ready(function () {
        $("#addclientsection").hide();
        $("#btnaddclient").click(function () {
            $("#addclientsection").toggle();
        });
    });
</script>

<div class="container-fluid p-5 mb-3 rounded bg-white" id="addclientsection">
    <div class="row">
        <div class="col-md-12 text-center">
            <h4>Add Client Details</h4>
            <hr>
        </div>
        <div class="container gcn">
            <form method="POST">
                {% csrf_token %}
                <div class="row">
                    <div class="col-md-4 form-group">
                        <label>Date</label>
                        <input id="date" type="date" name="date" class="form-control" required />
                    </div>
                    <div class="col-md-4 form-group">
                        <label>Client Name</label>
                        <input type="text" name="name" class="form-control" required />
                    </div>
                    <div class="col-md-4 form-group">
                        <label>Mobile No</label>
                        <input type="text" name="mobileno" class="form-control" required />
                    </div>
                    <div class="col-md-4 form-group">
                        <label>City</label>
                        <!-- <input type="text" id="city" name="city" class="form-control" value="{{user_city}}" readonly /> -->
                        <select name="city" class="form-control" id="" required>
                            <option value="">Select City</option>
                            {% for city in cities %}
                                <option value="{{city.id}}">{{city.name}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4 form-group">
                        <label> Treatment Service</label>
                        <select name="service" class="form-control" required>
                            <option value=""> Select Service..</option>
                                {% for service in services %}
                            <option value="{{service.id}}">{{ service.name }}</option>
                            {%endfor%}
                        </select>
                    </div>
                    <div class="col-md-4 form-group">
                        <label> Treatment By-</label>
                        <select name="serviceby" class="form-control" required>
                            <option value=""> Select Staff..</option>
                                {% for staff in staffs %}
                            <option value="{{staff.id}}">{{ staff.name }}</option>
                            {%endfor%}
                        </select>
                    </div>
                    <div class="col-md-4 form-group">
                        <label>Duration(In-Minute)</label>
                        <select id="duration" name="duration" class="form-control" required>
                            <option value="">Select Duration..</option>
                            {% for d in duration %}
                                <option value="{{d.duration}}">{{ d.duration }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4 form-group">
                        <label>Time-In</label>
                        <input id="timein" onchange="myFunction(this)" type="time" name="timein" class="form-control"
                            required />
                    </div>
                    <div class="col-md-4 form-group">
                        <label for="timeout" class="labels">Time-Out</label>
                        <input id="timeout" type="time" name="timeout" class="form-control" required="required" readonly/>
                    </div>
                    <div class="col-md-4 form-group">
                        <label>Price</label>
                        <input type="text" name="price" class="form-control" required />
                    </div>
                    <div class="col-md-4 form-group">
                        <label>Payment Mode</label>
                        <select id="pm" name="paym" class="form-control" required>
                            <option value=""> Select Payment mode</option>
                            {% for p in paym %}
                                <option value="{{p.id}}">{{ p.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <input type="submit" class="btn btn-primary w-100 font-weight-bold" value="Add New Client">
            </form>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<!--  -->
<script>
    function myFunction(x) {
        let [h, m] = x.value.split(":")
        let d = eval($('#duration').val()) + eval(15) + eval(m)
        let r = Math.floor(d / 60)
        m2 = d - (60 * r)
        h2 = eval(h) + eval(r)
        if (h2 < 10 & m2 < 10) {
            $('#timeout').val("0" + h2 + ":0" + m2)
            console.log("0" + h2 + ":0" + m2)

        } else if (m2 < 10) {
            $('#timeout').val(h2 + ":0" + m2)
            console.log(h2 + ":0" + m2)

        }
        else if (h2 < 10) {
            $('#timeout').val("0" + h2 + ":" + m2)
            console.log("0" + h2 + ":" + m2)

        }
        else if (h2 >= 24) {
            let carry = h2 - 24
            $('#timeout').val("0" + carry + ":" + m2)
        }

        else {
            $('#timeout').val(h2 + ":" + m2)
            console.log(h2 + ":" + m2)
        }
    }

</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<!--Client details here-->

<div class="container-fluid p-3 rounded bg-white" id="clientlisttable">
    <div class="row">
        <div class="col-md-12 text-center">
            <h4>Client Details</h4>
        </div>
        <div class="col-12">
            <table id="tblclientlist" class="table table-striped table-bordered table-sm table-responsive">
                <thead class="alert-light">
                    <tr>
                        <th class=" text-center th-sm">Date</th>
                        <th class=" text-center th-sm">Client Name</th>
                        <th class=" text-center th-sm">Mobile</th>
                        <th class="text-center th-sm">Treatment</th>
                        <th class=" text-center th-sm">Treatment By</th>
                        <th class="text-center th-sm">Duration</th>
                        <th class="text-center th-sm">City</th>
                        <th class=" text-center th-sm">Time In</th>
                        <th class="text-center th-sm">Time Out</th>
                        <th class="text-center th-sm">Price</th>
                        <th class="text-center th-sm">Payment Mode</th>
                        <th class="text-center th-sm">Comments</th>
                        <th class="text-center th-sm notexport">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for guest in guests %}
                    <tr class="text-center">
                        <td class="text-center">{{guest.date|date:'Y-m-d'}}</td>
                        <td class="text-center">{{guest.gname}}</td>
                        <td class="text-center">{{guest.mobile}}</td>
                        <td class="text-center">{{guest.services}}</td>
                        <td class="text-center">{{guest.treatment_by}}</td>
                        <td class="text-center">{{guest.duration}}</td>
                        <td class="text-center">{{guest.city}}</td>
                        <td class="text-center">{{guest.time_in}}</td>
                        <td class="text-center">{{guest.time_out}}</td>
                        <td class="text-center">{{guest.price}}</td>
                        <td class="text-center">{{guest.payment}}</td>
                        <td class="text-center">{{guest.comments}}</td>
                        <td class="notexport"> 
                        <div class="btn-group" role="group" aria-label="Basic example">
                            <a class="btn btn-sm btn-warning text-white" id="out{{guest.id}}"
                                onclick="out_{{guest.id}}(this)" data-toggle="modal" data-target="#myModalss">Out
                            </a>
                            <a class="btn btn-sm btn-danger text-white" onclick="delete_{{ guest.id }}()"
                                data-toggle="modal" data-target="#delete_modal">Delete
                            </a>
                        </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!--edit client details Modal -->
        <div class="modal fade" id="myModal" role="dialog">
            <div class="modal-dialog">
                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"></button>
                        <h4 class="modal-title text-center">EDIT CLIENTS DETAIL</h4>
                    </div>
                    <div class="modal-body">
                        <form id="update_form" method="POST">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="name" class="label">Duration</label>
                                <input id="duration" type="text" name="duration" class="form-control"
                                    required />
                            </div>
                            <div class="form-group">
                                <label for="name" class="label">Time_In</label>
                                <input id="timein" type="time" name="time_in" class="form-control"
                                    required />
                            </div>
                            <div class="form-group">
                                <label for="name" class="label">Time_Out</label>
                                <input id="timeout" type="time" name="time_out" class="form-control"
                                    required />
                            </div>
                            <div class="form-group">
                                <label for="total_time" class="label">Total Time</label>
                                <input id="total_time" type="text" name="total_time" onfocus="myFunction()"
                                    class="form-control" required />
                            </div>
                            <div id="com" class="form-group">
                                <label for="comments" class="label">Comments(Why Delay)</label>
                                <textarea id="comments" name="comments" class="form-control"
                                    required> </textarea>
                            </div>
                            <div class="form-group">
                                <button type="submit" class="btn btn-sm btn-success">Update</button>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- end of edit client details Modal -->

        <!--Delete client details Modal -->
        <div class="modal fade" id="myModals" role="dialog">
            <div class="modal-dialog">
                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header text-center">
                        <button type="button" class="close" data-dismiss="modal"></button>
                        <h4 class="modal-title">Delete Client Details</h4>
                    </div>
                    <div class="modal-body">
                        <table class="table table-bordered table-responsive" style="color: black">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Name</th>
                                    <th>Service</th>
                                    <th>Treatment By</th>
                                    <th>Payment</th>
                                </tr>
                            </thead>
        
                            <tbody>
                                {% for rep in rep_guests %}
                                <tr>
                                    <td>{{rep.date}}</td>
                                    <td>{{rep.gname}}</td>
                                    <td>{{rep.services.name}}</td>
                                    <td>{{rep.treatment_by}}</td>
                                    <td>{{rep.payment}}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                    </div>
                </div>

            </div>
        </div>
        <!--end of Delete client details Modal -->

        <!--Delay option Modal -->
        <div class="modal fade myModalss" id="myModalss" role="dialog">
            <div class="modal-dialog">
                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header text-center">
                        <button type="button" class="close" data-dismiss="modal"></button>
                        <h4 class="modal-title">Client</h4>
                    </div>
                    <div class="modal-body">
                        <form id="updates_form" method="POST">
                            {% csrf_token %}
                            <label id="delay">Why Delay</label>
                            <textarea name="cmt" rows="8" cols="80" class="form-control" id="cmt"></textarea>
                            <br>
                            <div class="row form-group">
                                <div class="col-6"><button type="submit" class="btn btn-lg btn-block btn-success">Submit</button></div>
                                <div class="col-6 text-right"><button type="button" class="btn btn-lg btn-danger" data-dismiss="modal">Close</button></div>
                            </div>
                        </form>
                    </div>
                    
                </div>
            </div>
        </div>
        <!--end of Delay option Modal -->

        <!--delete client details-->
        <div class="modal fade" id="delete_modal" role="dialog">
            <div class="modal-dialog">

                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"></button>
                        <h4 class="modal-title text-center">Delete Client Details</h4>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure want to delete city</p>


                        <a id="s_delete" class="btn btn-danger">Delete</a>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                    </div>
                </div>

            </div>
        </div>
        <!--end of delete client details-->
    </div>
</div>

<script>
    {% for guest in guests %}

        function delete_{{guest.id}} () {
            $('#s_delete').attr('href', "guest/gdel/{{guest.id}}")
        }
        //end of delete Client

        function out_{{ guest.id }} (x) {
            $("#cmt").val("{{ guest.cmt }}")
            $("#updates_form").attr("action", "update_guest/{{ guest.id}}")
            let t_out = "{{guest.time_out}}"
            let t_now = new Date().toLocaleTimeString()

            let t_24_out = get24hTime(t_out)
            let t_24_now = get24hTime(t_now)

            let [h1, m1] = t_24_out.split(":");
            let [h2, m2] = t_24_now.split(":");
            let hh = eval(h2) - eval(h1);
            let mm = eval(m2) - eval(m1);
            //mm = mm.replace(/-/g,"");
            mm = Math.abs(mm);
            time_now = get24tomin(t_24_now);
            time_out = get24tomin(t_24_out);
            min_diff = eval(time_now) - eval(time_out);
            $("#delay").html("<label>Why delay by  " + min_diff + " Minutes</label>");
            if (time_now <= time_out) {
                $(".myModalss").removeAttr('id');
                //$("#out{{g.id}}").hide();
            } else {
                $(".myModalss").attr('id', 'myModalss')
            }
        }
    {% endfor %}

    function get24tomin(time) {
        let [h, m] = time.split(":");
        return (eval(h) * 60) + eval(m)
    }

    function get24hTime(str) {
        str = String(str).toLowerCase().replace(/\s/g, '');
        str = String(str).toLowerCase().replace(/\./g, '');
        var has_am = str.indexOf('am') >= 0;
        var has_pm = str.indexOf('pm') >= 0;
        // first strip off the am/pm, leave it either hour or hour:minute
        str = str.replace('am', '').replace('pm', '');
        // if hour, convert to hour:00
        if (str.indexOf(':') < 0) str = str + ':00';
        // now it's hour:minute
        // we add am/pm back if striped out before
        if (has_am) str += ' am';
        if (has_pm) str += ' pm';
        // now its either hour:minute, or hour:minute am/pm
        // put it in a date object, it will convert to 24 hours format for us
        var d = new Date("1/1/2011 " + str);
        // make hours and minutes double digits
        var doubleDigits = function (n) {
            return (parseInt(n) < 10) ? "0" + n : String(n);
        };
        return doubleDigits(d.getHours()) + ':' + doubleDigits(d.getMinutes());
    }
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

<script>
    $('#tblclientlist').dataTable({
        dom: 'Bfrtip',
        buttons: [{
            extend: 'excelHtml5',
            title: 'GUEST LIST',
            text: 'Export to excel',
            className: 'btn btn-success',
            footer: true,
            exportOptions: {
                columns: ':not(.notexport)'
            }

            //Columns to export
            //exportOptions: {
            //     columns: [0, 1, 2, 3,4,5,6]
            // }
        }, {
            extend: 'pdfHtml5',
            title: 'GUEST LIST',
            text: 'Export to PDF',
            className: 'btn btn-primary ml-1',
            footer: true,
            exportOptions: {
                columns: ':not(.notexport)'
            }
            //Columns to export
            //exportOptions: {
            //     columns: [0, 1, 2, 3, 4, 5, 6]
            //  }
        }],
    })
</script>


<script>
    $(window).load(function () {
        date = document.getElementById("date")
        date.value = new Date().toISOString().substr(0, 10)

    });
</script>
{% endblock %}